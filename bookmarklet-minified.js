(function(){'use strict';const STORAGE_KEY='berklee_ensemble_clicker',REFRESH_INTERVAL=1000,SCRIPT_KEY='berklee_ensemble_script',UI_INJECTED_KEY='berklee_ui_injected';let state=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{"active":false,"clickCount":0,"windowOpened":false,"isNavigating":false}');const shouldAutoStart=localStorage.getItem(SCRIPT_KEY)==='active';// Injects the Berklee App UI into the target window
function injectUIIntoWindow(a){if(!a||!a.document)return;if(a.document.getElementById('berklee-app-ui'))return;const b=a.document.getElementById('schedule_container');if(!b)return;b.style.display='flex';b.style.flexDirection='column';b.style.gap='0px';b.style.alignItems='center';b.style.marginBottom='20px';b.style.overflow='visible';const c=b.nextElementSibling;if(c&&c.tagName.toLowerCase()==='center')c.style.marginTop='20px';const d=a.document.createElement('div');d.id='berklee-app-ui';d.style.cssText='width:662px;max-width:662px;min-width:662px;background:white;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.15);max-height:80vh;overflow-y:auto;margin-left:auto;margin-right:auto;margin-top:20px;padding-bottom:0px;';d.innerHTML='<style>#berklee-app-ui *{margin:0;padding:0;box-sizing:border-box}#berklee-app-ui .room-selection-wrapper{display:flex;flex-direction:column;padding:20px;gap:20px;background-color:#eeece5;border-radius:8px;width:100%;height:fit-content}#berklee-app-ui .add-time-slot{width:100%;box-shadow:-1px 1px 2px rgba(139,138,133,0.2) inset,1px -1px 2px rgba(139,138,133,0.2) inset,-1px -1px 2px rgba(255,255,255,0.9) inset,1px 1px 3px rgba(139,138,133,0.9) inset;border-radius:2px;background-color:rgba(224,222,215,0.72);height:39px;display:flex;flex-direction:row;align-items:center;justify-content:center;padding:0px 35px;box-sizing:border-box;font-size:10px;color:#3a3a3a;font-family:\'Jaldi\',sans-serif}#berklee-app-ui .room-details{width:582px;max-width:582px;display:flex;flex-direction:row;align-items:center;justify-content:space-between;gap:10px}#berklee-app-ui .room-number,#berklee-app-ui .time-slot{box-shadow:0px 1px 3px rgba(0,0,0,0.12);border-radius:1px;background-color:#eeece5;height:19px;display:flex;flex-direction:row;align-items:center;justify-content:center;padding:8px 20px;box-sizing:border-box;outline:none;font-size:10px;color:#3a3a3a;font-family:\'Jaldi\',sans-serif;cursor:text;text-align:center;line-height:1;position:relative;caret-color:transparent!important;-webkit-caret-color:transparent!important;-moz-caret-color:transparent!important;-ms-caret-color:transparent!important;flex:1}#berklee-app-ui .room-number:empty::before,#berklee-app-ui .time-slot:empty::before{content:attr(data-placeholder);color:#8a8a8a;opacity:1;pointer-events:none}#berklee-app-ui .room-number:focus::before,#berklee-app-ui .time-slot:focus::before,#berklee-app-ui .room-number:not(:empty)::before,#berklee-app-ui .time-slot:not(:empty)::before{display:none}#berklee-app-ui .room-number:hover,#berklee-app-ui .time-slot:hover{background-color:#f0f8ff;border:1px solid #87ceeb}#berklee-app-ui .room-number.selection-active,#berklee-app-ui .time-slot.selection-active{background-color:#e3f2fd!important;border:2px solid #2196f3!important;box-shadow:0 0 0 2px rgba(33,150,243,0.2)!important}#berklee-app-ui .room-number.selection-active{background-color:#e3f2fd!important;border:2px solid #2196f3!important;box-shadow:0 0 0 2px rgba(33,150,243,0.2)!important}#berklee-app-ui .time-slot.selection-active{background-color:#fff3e0!important;border:2px solid #ff9800!important;box-shadow:0 0 0 2px rgba(255,152,0,0.2)!important}.time-start-selected{background-color:#ffeb3b!important;border:2px solid #fbc02d!important;box-shadow:0 0 0 2px rgba(251,192,45,0.3)!important}#berklee-app-ui .go-button{width:24px;height:24px;border-radius:50%;cursor:pointer;flex-shrink:0}#berklee-app-ui .go-button:hover{}#berklee-app-ui .room-list{width:100%;box-shadow:-1px 1px 2px rgba(219,218,212,0.2) inset,1px -1px 2px rgba(219,218,212,0.2) inset,-1px -1px 2px rgba(255,255,255,0.9) inset,1px 1px 3px rgba(219,218,212,0.9) inset;border-radius:2px;background-color:#f3f2ec;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:20px 20px;box-sizing:border-box;gap:20px;font-size:10px;color:#3a3a3a;font-family:\'Jaldi\',sans-serif;min-height:200px}#berklee-app-ui .room-item{width:100%;box-shadow:0px 0px 3.2px rgba(0,0,0,0.17);background-color:#f3f2ec;display:flex;flex-direction:row;align-items:center;justify-content:flex-start;padding:8px 15px;box-sizing:border-box;border-radius:4px;transition:transform 0.2s ease;position:relative}#berklee-app-ui .room-item-content{flex:1;display:flex;flex-direction:row;align-items:center;justify-content:space-between;gap:10px}#berklee-app-ui .sort-button{width:8.6px;border-radius:2px;height:7.1px;cursor:grab;flex-shrink:0}#berklee-app-ui .sort-button:hover{}#berklee-app-ui .sort-button:active{cursor:grabbing}#berklee-app-ui .room-number-item,#berklee-app-ui .time-slot-item{border-radius:1px;height:19px;display:flex;flex-direction:row;align-items:center;justify-content:center;padding:8px 10px;box-sizing:border-box;font-size:10px;font-family:\'Jaldi\',sans-serif;color:#3a3a3a;background-color:rgba(255,255,255,0);border-radius:2px;min-width:60px;text-align:center}#berklee-app-ui .remove-button{width:13.5px;height:12.8px;cursor:pointer;flex-shrink:0}#berklee-app-ui .remove-button:hover{}#berklee-app-ui .room-item.dragging{opacity:0.7;z-index:1000;pointer-events:none;transition:none;position:fixed}#berklee-app-ui .room-item.drag-placeholder{opacity:0;background-color:transparent;border:none;height:40px;margin:10px 0}#berklee-app-ui .StartButtonSection{width:100%;position:relative;height:43px;padding:9px 20px;flex-direction:column;justify-content:center;align-items:center;gap:10px;display:flex;box-sizing:border-box;pointer-events:none}#berklee-app-ui .Frame1{padding:6px 9px;justify-content:center;align-items:center;gap:10px;display:inline-flex;pointer-events:auto}#berklee-app-ui .StartButtonFrame{width:25px;height:25px;background:#F5F5F4;box-shadow:-1px 1px 3px rgba(176,176,176,0.90);border-radius:4px;display:flex;justify-content:center;align-items:center;cursor:pointer;position:relative;flex-shrink:0}</style><div class="room-selection-wrapper"><div class="add-time-slot"><div class="room-details"><div class="room-number" contenteditable="true" data-placeholder="Room"></div><div class="time-slot" contenteditable="true" data-placeholder="Time"></div><div data-svg-wrapper data-layer="Go Button" class="go-button" style="position: relative"><svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><g filter="url(#filter0_di_2_26)"><rect x="3" y="0.5" width="18" height="18" rx="7" fill="#EEEEEE"/><path d="M12 5.18L12 13.82M16.32 9.5L7.68 9.5" stroke="#3A3A3A" stroke-width="0.5" stroke-linecap="round"/></g><defs><filter id="filter0_di_2_26" x="0" y="0.5" width="24" height="24" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB"><feFlood flood-opacity="0" result="BackgroundImageFix"/><feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/><feOffset dy="3"/><feGaussianBlur stdDeviation="1.5"/><feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0"/><feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2_26"/><feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2_26" result="shape"/><feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/><feOffset/><feGaussianBlur stdDeviation="0.15"/><feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1"/><feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/><feBlend mode="normal" in2="shape" result="effect2_innerShadow_2_26"/></filter></defs></svg></div></div></div><div class="room-list"><div class="room-item"><div class="room-item-content"><svg class="sort-button" alt="Sort" width="8.6" height="7.1" viewBox="0 0 9 8" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="8.6" height="1.2" fill="#666"/><rect y="3.4" width="8.6" height="1.2" fill="#666"/><rect y="6.8" width="8.6" height="1.2" fill="#666"/></svg><div class="room-number-item">130-A03</div><div class="time-slot-item">6pm - 8pm</div><svg class="remove-button" alt="Remove" width="13.5" height="12.8" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1l12 11M13 1L1 12" stroke="#666" stroke-width="2"/></svg></div></div></div><div class="StartButtonSection"><div class="Frame1"><div class="StartButtonFrame"><svg width="11" height="11" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.78344 1.13546L2.66909 1.35778L2.66909 1.35778L2.78344 1.13546ZM9.43232 4.55516L9.54667 4.33284L9.54667 4.33284L9.43232 4.55516ZM9.43232 6.44484L9.54667 6.66716L9.54667 6.66716L9.43232 6.44484ZM2.78344 9.86454L2.66909 9.64222L2.66909 9.64222L2.78344 9.86454ZM2.78344 1.13546L2.66909 1.35778L9.31798 4.77748L9.43232 4.55516L9.54667 4.33284L2.89778 0.913145L2.78344 1.13546ZM9.43232 6.44484L9.31798 6.22252L2.66909 9.64222L2.78344 9.86454L2.89778 10.0869L9.54667 6.66716L9.43232 6.44484ZM1 2.26927H0.75V8.73073H1H1.25V2.26927H1ZM2.78344 9.86454L2.66909 9.64222C2.02651 9.97271 1.25 9.49782 1.25 8.73073H1H0.75C0.75 9.84831 1.90162 10.5992 2.89778 10.0869L2.78344 9.86454ZM9.43232 4.55516L9.31798 4.77748C9.89401 5.07375 9.89401 5.92625 9.31798 6.22252L9.43232 6.44484L9.54667 6.66716C10.4844 6.18483 10.4844 4.81517 9.54667 4.33284L9.43232 4.55516ZM2.78344 1.13546L2.89778 0.913145C1.90161 0.40079 0.75 1.15169 0.75 2.26927H1H1.25C1.25 1.50218 2.02651 1.02729 2.66909 1.35778L2.78344 1.13546Z" fill="#3A3A3A"/></svg></div></div></div></div>';b.appendChild(d);initUI(a);}// Initializes the UI functionality and event handlers
function initUI(a){const b=a.document.getElementById('berklee-app-ui');if(!b)return;const c=b.querySelector('.go-button'),d=b.querySelector('.StartButtonFrame'),e=b.querySelector('.room-list'),f=b.querySelector('.room-number'),g=b.querySelector('.time-slot');let h=null,i=null,j=false,k=false,l=new Set(),m=false,n='start',o=null;// Drag and drop state variables
let dragState={isDragging:false,draggedElement:null,placeholder:null,startY:0,startX:0,originalIndex:0,currentIndex:0};// Sets up room selection functionality
function p(){if(f){f.addEventListener('click',function(p){if(!j){p.stopPropagation();if(m)exitTimeSelection();j=true;k=false;l.clear();f.classList.add('selection-active');f.textContent='Click room or Cmd+click for multi-select...';u();setupTimeClickDuringRoomSelection();a.document.addEventListener('click',v);a.document.addEventListener('keydown',w);}});}const q=a.document.getElementById('tab_wrap');if(q){q.addEventListener('click',function(p){const q=p.target.closest('th, td');if(q&&j){p.preventDefault();p.stopPropagation();p.stopImmediatePropagation();const r=p.metaKey||p.ctrlKey;let roomText='';const t=a.document.createTreeWalker(q,NodeFilter.SHOW_TEXT,{acceptNode:function(a){const b=a.parentElement;if(b&&b.tagName.toLowerCase()==='span')return NodeFilter.FILTER_REJECT;return NodeFilter.FILTER_ACCEPT;}});let u;while(u=t.nextNode())roomText+=u.textContent;roomText=roomText.trim();if(roomText){if(r){k=true;if(l.has(roomText)){l.delete(roomText);q.classList.remove('room-selected');}else{l.add(roomText);q.classList.add('room-selected');}r1();}else{if(k&&l.size>0){l.add(roomText);q.classList.add('room-selected');r1();}else{f.textContent=roomText;x();}}}}},true);}}// Updates room selection display text
function r1(){if(l.size===0)f.textContent='Click room or Cmd+click for multi-select...';else if(l.size===1)f.textContent=Array.from(l)[0]+' (Click time or press Enter)';else f.textContent=`${l.size} rooms selected (Click time or press Enter)`;}// Sets up time clicking during room selection
function setupTimeClickDuringRoomSelection(){h=function(p){const q=p.target.closest('td, th');if(q&&j){const r=q.textContent.trim();const timeRegex=/^\s*\d{1,2}(?::\d{2})?\s*(?:am|pm|AM|PM)?\s*(?:\s*[-–]\s*\d{1,2}(?::\d{2})?\s*(?:am|pm|AM|PM)?)?\s*$/;const t=timeRegex.test(r)&&r.length>1&&r.length<20&&!r.toLowerCase().includes('book')&&!r.toLowerCase().includes('slot')&&!r.toLowerCase().includes('reserve')&&!r.toLowerCase().includes('available')&&!r.toLowerCase().includes('click')&&!q.classList.contains('booking')&&!q.classList.contains('booked')&&!q.querySelector('button, input, a');if(t&&l.size>0){p.preventDefault();p.stopPropagation();p.stopImmediatePropagation();if(f){if(l.size===1){f.textContent=Array.from(l)[0];}else{f.textContent=`${l.size} rooms selected`;}}x();if(g){m=true;n='start';o=null;g.classList.add('selection-active');g.textContent='Click start time in schedule...';y();a.document.addEventListener('click',z);a.document.addEventListener('keydown',A);}}}};const scheduleFrame=a.document.getElementById('scheduleframe');if(scheduleFrame){const setupScheduleFrameListener=()=>{try{const frameDoc=scheduleFrame.contentDocument||scheduleFrame.contentWindow.document;if(frameDoc){frameDoc.addEventListener('click',h,true);}}catch(e){}};setupScheduleFrameListener();scheduleFrame.addEventListener('load',setupScheduleFrameListener);}const scheduleTab=a.document.getElementById('emsscheduletab');if(scheduleTab){scheduleTab.addEventListener('click',h,true);}}// Handles Enter key press during room selection
function w(p){if(p.key==='Enter'&&j&&l.size>0){p.preventDefault();p.stopPropagation();if(f){if(l.size===1){f.textContent=Array.from(l)[0];}else{f.textContent=`${l.size} rooms selected`;}}x();if(g){m=true;n='start';o=null;g.classList.add('selection-active');g.textContent='Click start time in schedule...';y();a.document.addEventListener('click',z);a.document.addEventListener('keydown',A);}}}// Handles Enter key press during time selection
function A(p){if(p.key==='Enter'&&m&&o){p.preventDefault();p.stopPropagation();if(l.size>0)B();exitTimeSelection();}}// Formats time text for display
function C(a){return a.replace(/(\d+)(am|pm)/gi,'$1 $2');}// Creates room items from selected rooms and time
function B(){const p=g.textContent.trim();if(l.size>0&&p&&p!=='Time'&&p!=='Click start time in schedule...'){Array.from(l).forEach(q=>{const r=a.document.createElement('div');r.className='room-item';const s=C(p);r.innerHTML=`<div class="room-item-content"><svg class="sort-button" alt="Sort" width="8.6" height="7.1" viewBox="0 0 9 8" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="8.6" height="1.2" fill="#666"/><rect y="3.4" width="8.6" height="1.2" fill="#666"/><rect y="6.8" width="8.6" height="1.2" fill="#666"/></svg><div class="room-number-item">${q}</div><div class="time-slot-item">${s}</div><svg class="remove-button" alt="Remove" width="13.5" height="12.8" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1l12 11M13 1L1 12" stroke="#666" stroke-width="2"/></svg></div>`;const t=r.querySelector('.remove-button');t.addEventListener('click',function(){r.remove();});e.appendChild(r);});l.clear();k=false;f.textContent='Room';g.textContent='Time';setupDragAndDrop();}}// Applies selectable styles to room cells
function u(){const p=a.document.getElementById('tab_wrap');if(p){const q=p.querySelectorAll('th, td');q.forEach(a=>{a.style.cursor='pointer';a.style.backgroundColor='#f0f8ff';a.style.border='1px solid #87ceeb';a.classList.add('room-selectable');});}a.document.body.classList.add('room-selection-active');const q=a.document.createElement('style');q.textContent='.room-selected{background-color:#4CAF50!important;color:white!important;border:2px solid #45a049!important;}.room-selectable:hover{background-color:#e6f3ff!important;}.room-selected:hover{background-color:#45a049!important;}.room-selection-active .room-selectable:hover{background-color:#f0f8ff!important;}';q.id='room-selection-styles';a.document.head.appendChild(q);}// Removes selectable styles from room cells
function E(){const p=a.document.getElementById('tab_wrap');if(p){const q=p.querySelectorAll('th.room-selectable, td.room-selectable');q.forEach(a=>{a.style.cursor='';a.style.backgroundColor='';a.style.border='';a.classList.remove('room-selectable');a.classList.remove('room-selected');});}a.document.body.classList.remove('room-selection-active');const q=a.document.getElementById('room-selection-styles');if(q)q.remove();}// Exits room selection mode
function x(){j=false;k=false;if(f)f.classList.remove('selection-active');E();cleanupTimeClickHandlers();a.document.removeEventListener('click',v);a.document.removeEventListener('keydown',w);}// Cleans up time click handlers during room selection
function cleanupTimeClickHandlers(){if(h){const scheduleFrame=a.document.getElementById('scheduleframe');if(scheduleFrame){try{const frameDoc=scheduleFrame.contentDocument||scheduleFrame.contentWindow.document;if(frameDoc){frameDoc.removeEventListener('click',h,true);}}catch(e){}}const scheduleTab=a.document.getElementById('emsscheduletab');if(scheduleTab){scheduleTab.removeEventListener('click',h,true);}h=null;}}// Handles clicks outside room selection area
function v(p){const q=p.target,r=q.closest('#berklee-app-ui'),s=q.closest('#tab_wrap'),t=q.closest('#emsscheduletab');if(!r&&!s&&!t){if(f&&(k||l.size>0))f.textContent='Room';l.clear();k=false;x();}}// Sets up time selection functionality
function F(){if(g){g.addEventListener('click',function(p){if(!m){p.stopPropagation();if(j)x();m=true;n='start';o=null;g.classList.add('selection-active');g.textContent='Click start time in schedule...';y();a.document.addEventListener('click',z);}});}const p=a.document.getElementById('scheduleframe');if(p){const q=()=>{try{const q=p.contentDocument||p.contentWindow.document;if(q){q.addEventListener('click',function(p){if(m){const q=p.target.closest('td, th');if(q){const r=q.textContent.trim();const timeRegex=/^\s*\d{1,2}(?::\d{2})?\s*(?:am|pm|AM|PM)?\s*(?:\s*[-–]\s*\d{1,2}(?::\d{2})?\s*(?:am|pm|AM|PM)?)?\s*$/;const t=timeRegex.test(r)&&r.length>1&&r.length<20&&!r.toLowerCase().includes('book')&&!r.toLowerCase().includes('slot')&&!r.toLowerCase().includes('reserve')&&!r.toLowerCase().includes('available')&&!r.toLowerCase().includes('click')&&!q.classList.contains('booking')&&!q.classList.contains('booked')&&!q.querySelector('button, input, a');if(t){p.preventDefault();p.stopPropagation();p.stopImmediatePropagation();if(n==='start'){o=r;n='end';q.classList.add('time-start-selected');if(g)g.textContent=`${r} - (select end time)`;G();}else if(n==='end'){const endTime=r,timeRange=`${o} - ${endTime}`;if(g)g.textContent=timeRange;if(l.size>0)B();exitTimeSelection();}}}}},true);}}catch(p){}};q();p.addEventListener('load',q);}}// Applies selectable styles to time cells
function y(){const p=a.document.getElementById('scheduleframe');if(p){try{const q=p.contentDocument||p.contentWindow.document;if(q){const p=q.querySelectorAll('td, th');p.forEach(a=>{const p=a.textContent.trim();const q=/^\s*\d{1,2}(?::\d{2})?\s*(?:am|pm|AM|PM)?\s*(?:\s*[-–]\s*\d{1,2}(?::\d{2})?\s*(?:am|pm|AM|PM)?)?\s*$/;const r=q.test(p)&&p.length>1&&p.length<20&&!p.toLowerCase().includes('book')&&!p.toLowerCase().includes('slot')&&!p.toLowerCase().includes('reserve')&&!p.toLowerCase().includes('available')&&!p.toLowerCase().includes('click')&&!a.classList.contains('booking')&&!a.classList.contains('booked')&&!a.querySelector('button, input, a');if(r){a.style.cursor='pointer';a.style.backgroundColor='#fff3e0';a.style.border='1px solid #ff9800';a.classList.add('time-selectable');}});}}catch(p){}}const q=a.document.getElementById('emsscheduletab');if(q){const p=q.querySelectorAll('thead th, thead td'),r=q.querySelectorAll('tfoot th, tfoot td'),s=[...p,...r];s.forEach(a=>{a.style.cursor='pointer';a.style.backgroundColor='#fff3e0';a.style.border='1px solid #ff9800';a.classList.add('time-selectable');});}}// Removes selectable styles from time cells
function H(){const p=a.document.getElementById('scheduleframe');if(p){try{const q=p.contentDocument||p.contentWindow.document;if(q){const p=q.querySelectorAll('.time-selectable, .time-start-selected');p.forEach(a=>{a.style.cursor='';a.style.backgroundColor='';a.style.border='';a.classList.remove('time-selectable', 'time-start-selected');});}}catch(p){}}const q=a.document.getElementById('emsscheduletab');if(q){const p=q.querySelectorAll('.time-selectable, .time-start-selected');p.forEach(a=>{a.style.cursor='';a.style.backgroundColor='';a.style.border='';a.classList.remove('time-selectable', 'time-start-selected');});}}// Updates time cell styles for end selection
function G(){const p=a.document.getElementById('scheduleframe');if(p){try{const q=p.contentDocument||p.contentWindow.document;if(q){const p=q.querySelectorAll('.time-selectable');p.forEach(a=>{a.style.backgroundColor='#90EE90';a.style.border='2px solid #228B22';});}}catch(p){}}const q=a.document.getElementById('emsscheduletab');if(q){const p=q.querySelectorAll('.time-selectable');p.forEach(a=>{a.style.backgroundColor='#90EE90';a.style.border='2px solid #228B22';});}}// Exits time selection mode
function exitTimeSelection(){m=false;n='start';o=null;if(g)g.classList.remove('selection-active');H();a.document.removeEventListener('click',z);a.document.removeEventListener('keydown',A);}// Handles clicks outside time selection area
function z(p){const q=p.target,r=q.closest('#berklee-app-ui'),timeSchedule=q.closest('#emsscheduletab'),t=q.closest('#tab_wrap'),u=q.closest('#scheduleframe');if(!r&&!timeSchedule&&!t&&!u){if(g&&n==='end')g.textContent='Click to select time range...';l.clear();k=false;if(f)f.textContent='Room';exitTimeSelection();}}// Finds and books the next available slot based on room and time criteria
function FindAndBookNextAvailableSlot(){const roomItems=e.querySelectorAll('.room-item');if(roomItems.length===0)return;let scheduleTable=null;const scheduleFrame=a.document.getElementById('scheduleframe');if(scheduleFrame&&scheduleFrame.contentDocument){try{scheduleTable=scheduleFrame.contentDocument.getElementById('emsscheduletab');}catch(e){}}if(!scheduleTable){scheduleTable=a.document.getElementById('emsscheduletab');}if(!scheduleTable)return;const parseTime=timeStr=>{const match=timeStr.match(/(\d+)(?::(\d+))?\s*(am|pm)/i);if(!match)return null;let hours=parseInt(match[1]);const minutes=parseInt(match[2])||0;const ampm=match[3].toLowerCase();if(ampm==='pm'&&hours!==12)hours+=12;if(ampm==='am'&&hours===12)hours=0;return hours*60+minutes;};const parseTimeRange=timeRange=>{const parts=timeRange.split('-');if(parts.length!==2)return null;const start=parseTime(parts[0].trim());const end=parseTime(parts[1].trim());return start&&end?{start,end}:null;};for(let i=0;i<roomItems.length;i++){const roomItem=roomItems[i];const roomNumber=roomItem.querySelector('.room-number-item')?.textContent.trim();const timeSlot=roomItem.querySelector('.time-slot-item')?.textContent.trim();if(!roomNumber||!timeSlot)continue;const targetTimeRange=parseTimeRange(timeSlot);if(!targetTimeRange)continue;const rows=scheduleTable.querySelectorAll('tbody tr');for(const row of rows){const cells=row.querySelectorAll('td');for(const cell of cells){if(cell.classList.contains('booked'))continue;if(cell.classList.contains('bookslot')){const roomTimeData=cell.getAttribute('data-roomtime');if(!roomTimeData)continue;const match=roomTimeData.match(/^(.*?),\s*(.+)$/);if(!match)continue;const[,room,time]=match;const cellRoom=room.trim();const cellTime=time.trim();if(cellRoom===roomNumber){const cellTimeRange=parseTimeRange(cellTime);if(cellTimeRange&&cellTimeRange.start>=targetTimeRange.start&&cellTimeRange.end<=targetTimeRange.end){cell.click();return;}}}}}}}// Improved drag and drop functionality
function setupDragAndDrop(){const sortButtons=b.querySelectorAll('.sort-button');sortButtons.forEach(button=>{button.addEventListener('mousedown',startDrag);});}// Starts the drag operation
function startDrag(event){if(dragState.isDragging)return;event.preventDefault();const draggedItem=event.target.closest('.room-item');if(!draggedItem)return;dragState.isDragging=true;dragState.draggedElement=draggedItem;dragState.startY=event.clientY;dragState.startX=event.clientX;dragState.originalIndex=Array.from(e.children).indexOf(draggedItem);dragState.currentIndex=dragState.originalIndex;const rect=draggedItem.getBoundingClientRect();dragState.draggedElement.style.position='fixed';dragState.draggedElement.style.top=rect.top+'px';dragState.draggedElement.style.left=rect.left+'px';dragState.draggedElement.style.width=rect.width+'px';dragState.draggedElement.style.zIndex='10000';dragState.draggedElement.classList.add('dragging');createPlaceholder(draggedItem);a.document.addEventListener('mousemove',handleDragMove);a.document.addEventListener('mouseup',handleDragEnd);a.document.addEventListener('mouseleave',handleDragEnd);}// Creates a placeholder element
function createPlaceholder(originalElement){dragState.placeholder=a.document.createElement('div');dragState.placeholder.className='room-item drag-placeholder';dragState.placeholder.style.height=originalElement.offsetHeight+'px';e.insertBefore(dragState.placeholder,originalElement);}// Handles mouse movement during drag
function handleDragMove(event){if(!dragState.isDragging)return;const deltaY=event.clientY-dragState.startY;const deltaX=event.clientX-dragState.startX;dragState.draggedElement.style.transform=`translate(${deltaX}px, ${deltaY}px)`;updateDragPosition(event);}// Updates the drag position and reorders items
function updateDragPosition(event){const draggedRect=dragState.draggedElement.getBoundingClientRect();const draggedCenter=draggedRect.top+draggedRect.height/2;const items=Array.from(e.querySelectorAll('.room-item:not(.dragging):not(.drag-placeholder)'));let newIndex=dragState.originalIndex;for(let i=0;i<items.length;i++){const itemRect=items[i].getBoundingClientRect();const itemCenter=itemRect.top+itemRect.height/2;if(draggedCenter<itemCenter){newIndex=i;break;}else{newIndex=i+1;}}if(newIndex!==dragState.currentIndex&&newIndex>=0&&newIndex<=items.length){dragState.currentIndex=newIndex;reorderItems();}}// Reorders the items based on current drag position
function reorderItems(){const items=Array.from(e.querySelectorAll('.room-item:not(.dragging):not(.drag-placeholder)'));if(dragState.currentIndex>=items.length){e.appendChild(dragState.placeholder);}else{e.insertBefore(dragState.placeholder,items[dragState.currentIndex]);}}// Handles the end of drag operation
function handleDragEnd(event){if(!dragState.isDragging)return;dragState.isDragging=false;if(dragState.draggedElement){dragState.draggedElement.style.position='';dragState.draggedElement.style.top='';dragState.draggedElement.style.left='';dragState.draggedElement.style.width='';dragState.draggedElement.style.zIndex='';dragState.draggedElement.style.transform='';dragState.draggedElement.classList.remove('dragging');if(dragState.placeholder&&dragState.placeholder.parentNode){e.insertBefore(dragState.draggedElement,dragState.placeholder);dragState.placeholder.remove();}else{e.appendChild(dragState.draggedElement);}}dragState.draggedElement=null;dragState.placeholder=null;a.document.removeEventListener('mousemove',handleDragMove);a.document.removeEventListener('mouseup',handleDragEnd);a.document.removeEventListener('mouseleave',handleDragEnd);}if(d){d.addEventListener('click',function(){startNavigationProcess();});}if(c){c.addEventListener('click',function(){const roomText=f.textContent.trim(),timeText=g.textContent.trim();if(l.size>0&&timeText&&timeText!=='Time'){B();}else if(roomText&&timeText&&roomText!=='Room'&&timeText!=='Time'){const newItem=a.document.createElement('div');newItem.className='room-item';const formattedTime=C(timeText);newItem.innerHTML=`<div class="room-item-content"><svg class="sort-button" alt="Sort" width="8.6" height="7.1" viewBox="0 0 9 8" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="8.6" height="1.2" fill="#666"/><rect y="3.4" width="8.6" height="1.2" fill="#666"/><rect y="6.8" width="8.6" height="1.2" fill="#666"/></svg><div class="room-number-item">${roomText}</div><div class="time-slot-item">${formattedTime}</div><svg class="remove-button" alt="Remove" width="13.5" height="12.8" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1l12 11M13 1L1 12" stroke="#666" stroke-width="2"/></svg></div>`;const removeBtn=newItem.querySelector('.remove-button');removeBtn.addEventListener('click',function(){newItem.remove();});e.appendChild(newItem);setupDragAndDrop();f.textContent='Room';g.textContent='Time';}});}b.querySelectorAll('.remove-button').forEach(a=>{a.addEventListener('click',function(){const b=a.closest('.room-item');b.remove();});});setupDragAndDrop();p();F();[f,g].forEach(a=>{if(a){a.addEventListener('focus',function(){if(!j&&!m){this.style.caretColor='transparent';this.style.webkitCaretColor='transparent';this.style.mozCaretColor='transparent';this.style.msCaretColor='transparent';}});a.addEventListener('input',function(){if(!j&&!m){this.style.caretColor='transparent';this.style.webkitCaretColor='transparent';this.style.mozCaretColor='transparent';this.style.msCaretColor='transparent';}});}});}if(shouldAutoStart&&!state.active){state.active=true;saveState();}else if(!state.active){state.active=true;state.clickCount=0;state.windowOpened=false;localStorage.setItem(STORAGE_KEY,JSON.stringify(state));localStorage.setItem(SCRIPT_KEY,'active');}// Saves current state to localStorage
function saveState(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}// Stops the script and cleans up resources
function stopScript(){state.active=false;state.isNavigating=false;localStorage.removeItem(STORAGE_KEY);localStorage.removeItem(SCRIPT_KEY);localStorage.removeItem(UI_INJECTED_KEY);if(window.berklee_interval)clearInterval(window.berklee_interval);if(window.berklee_target_window){try{const a=window.berklee_target_window.document.getElementById('berklee-app-ui');if(a)a.remove();}catch(a){}window.berklee_target_window.close();}}// Navigation and booking automation
function startNavigationProcess(){if(!window.berklee_target_window||window.berklee_target_window.closed)return;if(window.berklee_interval)clearInterval(window.berklee_interval);state.isNavigating=true;saveState();window.berklee_interval=setInterval(()=>{if(window.berklee_target_window&&!window.berklee_target_window.closed){try{const a=window.berklee_target_window.document,b=a.querySelector('#date_display_view');if(b){const c=b.textContent.trim(),d=c.match(/(\d{1,2})\s+(\w{3}),?\s+(\d{4})/);if(d){const[,e,f,g]=d,h={'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11},i=new Date(parseInt(g),h[f],parseInt(e)),j=new Date;j.setHours(0,0,0,0);i.setHours(0,0,0,0);const daysRemaining=Math.ceil((i.getTime()-j.getTime())/(1000*60*60*24));if(daysRemaining===2){window.berklee_target_window.location.reload();return;}if(daysRemaining===3){FindAndBookNextAvailableSlot();clearInterval(window.berklee_interval);state.isNavigating=false;saveState();return;}}}const c=a.querySelector("#maincontent > div > nav > div:nth-child(1) > h3 > a.daynav.nextbtn");if(c){const a=window.berklee_target_window.getComputedStyle(c),b=a.display==='none'||c.style.display==='none'||c.textContent.includes('?');if(b){clearInterval(window.berklee_interval);state.isNavigating=false;saveState();return;}state.clickCount++;saveState();c.click();}}catch(a){}}else stopScript();},REFRESH_INTERVAL);}// Main execution: Check if window is needed and set up the booking automation
const needsWindow=!state.windowOpened||!window.berklee_target_window||window.berklee_target_window.closed;if(needsWindow){const a=window.outerWidth||1200,b=window.outerHeight||800,c=window.screenX!==undefined?window.screenX:(window.screenLeft||0),d=window.screenY!==undefined?window.screenY:(window.screenTop||0),e=`width=${a},height=${b},left=${c},top=${d},resizable=yes,scrollbars=yes`;window.berklee_target_window=window.open(location.href,'berklee_ensemble_target',e);if(window.berklee_target_window){state.windowOpened=true;saveState();}else return;if(window.berklee_interval)clearInterval(window.berklee_interval);window.berklee_interval=setInterval(()=>{if(window.berklee_target_window&&!window.berklee_target_window.closed){try{injectUIIntoWindow(window.berklee_target_window);}catch(a){}}else stopScript();},REFRESH_INTERVAL);}})();
